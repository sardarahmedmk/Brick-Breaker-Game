<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ translations.get('checkout', 'Checkout') }} - E-Commerce Store</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">{{ translations.get('store_name', 'E-Store') }}</div>
            <div class="nav-center">
                <a href="/?lang={{ lang }}&currency={{ currency }}">{{ translations.get('home', 'Home') }}</a>
                <a href="/?lang={{ lang }}&currency={{ currency }}#products">{{ translations.get('products', 'Products') }}</a>
                <a href="/cart?lang={{ lang }}&currency={{ currency }}">{{ translations.get('cart', 'Cart') }}</a>
                <a href="/orders?lang={{ lang }}&currency={{ currency }}">{{ translations.get('my_orders', 'My Orders') }}</a>
            </div>
            <div class="nav-right">
                <select id="langSelect" onchange="changeLanguage(this.value)">
                    <option value="en" {% if lang == 'en' %}selected="selected"{% endif %}>English</option>
                    <option value="ur" {% if lang == 'ur' %}selected="selected"{% endif %}>Ø§Ø±Ø¯Ùˆ</option>
                </select>
                <select id="currencySelect" onchange="changeCurrency(this.value)">
                    <option value="USD" {% if currency == 'USD' %}selected="selected"{% endif %}>USD</option>
                    <option value="EUR" {% if currency == 'EUR' %}selected="selected"{% endif %}>EUR</option>
                    <option value="GBP" {% if currency == 'GBP' %}selected="selected"{% endif %}>GBP</option>
                    <option value="PKR" {% if currency == 'PKR' %}selected="selected"{% endif %}>PKR</option>
                    <option value="INR" {% if currency == 'INR' %}selected="selected"{% endif %}>INR</option>
                </select>
                <a href="/cart?lang={{ lang }}&currency={{ currency }}" class="cart-icon">ðŸ›’ <span id="cartCount">0</span></a>
            </div>
        </div>
    </nav>

    <main class="container">
        <h1>{{ translations.get('checkout', 'Checkout') }}</h1>

        <div class="checkout-container">
            <form class="checkout-form" onsubmit="submitOrder(event)">
                <div class="form-section">
                    <h2>{{ translations.get('shipping_address', 'Shipping Address') }}</h2>
                    
                    <div class="form-group">
                        <label>{{ translations.get('full_name', 'Full Name') }} *</label>
                        <input type="text" name="fullName" required>
                    </div>

                    <div class="form-group">
                        <label>{{ translations.get('email', 'Email') }} *</label>
                        <input type="email" name="email" required>
                    </div>

                    <div class="form-group">
                        <label>{{ translations.get('phone', 'Phone Number') }} *</label>
                        <input type="tel" name="phone" required>
                    </div>

                    <div class="form-group">
                        <label>{{ translations.get('address', 'Address') }} *</label>
                        <input type="text" name="address" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>{{ translations.get('city', 'City') }} *</label>
                            <input type="text" name="city" required>
                        </div>
                        <div class="form-group">
                            <label>{{ translations.get('country', 'Country') }} *</label>
                            <input type="text" name="country" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>{{ translations.get('state', 'State/Province') }} *</label>
                            <input type="text" name="state" required>
                        </div>
                        <div class="form-group">
                            <label>{{ translations.get('zip', 'Zip Code') }} *</label>
                            <input type="text" name="zip" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>{{ translations.get('payment_method', 'Payment Method') }}</h2>
                    
                    <div class="payment-options">
                        <label>
                            <input type="radio" name="paymentMethod" value="credit_card" checked>
                            {{ translations.get('credit_card', 'Credit Card') }}
                        </label>
                        <label>
                            <input type="radio" name="paymentMethod" value="debit_card">
                            {{ translations.get('debit_card', 'Debit Card') }}
                        </label>
                        <label>
                            <input type="radio" name="paymentMethod" value="paypal">
                            PayPal
                        </label>
                    </div>

                    <div id="cardDetails" class="form-section">
                        <div class="form-group">
                            <label>{{ translations.get('card_name', 'Cardholder Name') }} *</label>
                            <input type="text" name="cardName" required>
                        </div>

                        <div class="form-group">
                            <label>{{ translations.get('card_number', 'Card Number') }} *</label>
                            <input type="text" name="cardNumber" placeholder="1234 5678 9012 3456" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>{{ translations.get('expiry', 'Expiry Date') }} *</label>
                                <input type="text" name="expiry" placeholder="MM/YY" required>
                            </div>
                            <div class="form-group">
                                <label>{{ translations.get('cvv', 'CVV') }} *</label>
                                <input type="text" name="cvv" placeholder="123" required>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-place-order">
                    {{ translations.get('place_order', 'Place Order') }}
                </button>
            </form>

            <div class="order-summary">
                <h2>{{ translations.get('order_summary', 'Order Summary') }}</h2>
                <div id="orderItems"></div>
                <div class="summary-items">
                    <div class="summary-row">
                        <span>{{ translations.get('subtotal', 'Subtotal') }}:</span>
                        <span id="checkoutSubtotal">{{ currency }} 0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>{{ translations.get('shipping', 'Shipping') }}:</span>
                        <span id="checkoutShipping">{{ currency }} 0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>{{ translations.get('tax', 'Tax') }}:</span>
                        <span id="checkoutTax">{{ currency }} 0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>{{ translations.get('total', 'Total') }}:</span>
                        <span id="checkoutTotal">{{ currency }} 0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 E-Commerce Store. {{ translations.get('all_rights', 'All Rights Reserved') }}</p>
        </div>
    </footer>

    <script>
        const currency = '{{ currency }}';
        
        function changeLanguage(lang) {
            window.location.href = `/checkout?lang=${lang}&currency=${currency}`;
        }

        function changeCurrency(curr) {
            window.location.href = `/checkout?lang={{ lang }}&currency=${curr}`;
        }

        function loadCheckoutSummary() {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const orderItems = document.getElementById('orderItems');
            
            let subtotal = 0;
            let itemsHTML = '<div class="items-list">';
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                itemsHTML += `
                    <div class="item-row">
                        <span>${item.name} x ${item.quantity}</span>
                        <span>${currency} ${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            });
            
            itemsHTML += '</div>';
            orderItems.innerHTML = itemsHTML;
            
            const shipping = subtotal > 100 ? 0 : 10;
            const tax = subtotal * 0.1;
            const total = subtotal + shipping + tax;
            
            document.getElementById('checkoutSubtotal').textContent = `${currency} ${subtotal.toFixed(2)}`;
            document.getElementById('checkoutShipping').textContent = `${currency} ${shipping.toFixed(2)}`;
            document.getElementById('checkoutTax').textContent = `${currency} ${tax.toFixed(2)}`;
            document.getElementById('checkoutTotal').textContent = `${currency} ${total.toFixed(2)}`;
        }

        function updateCartCount() {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            let count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = count;
        }

        function submitOrder(event) {
            event.preventDefault();
            
            // Get form data
            const formData = {
                fullName: document.querySelector('input[name="fullName"]').value,
                email: document.querySelector('input[name="email"]').value,
                phone: document.querySelector('input[name="phone"]').value,
                address: document.querySelector('input[name="address"]').value,
                city: document.querySelector('input[name="city"]').value,
                country: document.querySelector('input[name="country"]').value,
                state: document.querySelector('input[name="state"]').value,
                zip: document.querySelector('input[name="zip"]').value
            };

            // Generate order ID
            const orderId = 'ORD-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            
            // Get cart summary
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = subtotal > 100 ? 0 : 10;
            const tax = subtotal * 0.1;
            const total = subtotal + shipping + tax;

            // Create order object
            const order = {
                id: orderId,
                date: new Date().toISOString(),
                stage: 0, // 0: pending, 1: processing, 2: shipped, 3: delivered
                customerInfo: formData,
                summary: {
                    items: cart,
                    subtotal: subtotal,
                    shipping: shipping,
                    tax: tax,
                    total: total
                }
            };

            // Save order
            let orders = JSON.parse(localStorage.getItem('orders')) || [];
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));

            // Clear cart and redirect
            localStorage.removeItem('cart');
            alert('{{ translations.get("order_success", "Order placed successfully!") }}\n{{ translations.get("order_id", "Order ID:") }} ' + orderId);
            window.location.href = `/orders?lang={{ lang }}&currency=${currency}`;
        }

        loadCheckoutSummary();
        updateCartCount();
    </script>
</body>
</html>
